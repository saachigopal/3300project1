
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<p style="font-family:avenir; font-size:25; text-align:center"> 2018 United States Senate Election Forecast vs. State Economic Growth </p>

<div style="text-align:center">
<svg width="730" height="730"></svg>

<script>
var stateData;
d3.json("projectdata.json", function(data) {
    stateData = data;
    console.log(stateData);
    showGraph();
});
function showGraph() {
    var svg = d3.select("svg");
    var xscale = d3.scaleLinear().domain([0,5.5]).range([0,640]);
    var yscale = d3.scaleLinear().domain([0,100]).range([640,0]);
    var rscale = d3.scaleLinear().domain([500000,40000000]).range([10,40]);
    var xaxis = d3.axisBottom(xscale);
    svg.append("g").attr("transform","translate(50,650)").call(xaxis);
    var yaxis = d3.axisLeft(yscale);
    svg.append("g").attr("transform","translate(50,10)").call(yaxis);

    svg.append("text").text("Probability of Democratic Victory (%)")
        .attr("x","0")
        .attr("y","25")
        .attr("transform","translate(-10,460) rotate(-90)")
        .style("font-family","avenir")
        .style("font-size","16");

    svg.append("text").text("Change in State GDP  (%)")
        .attr("x","250")
        .attr("y","695")
        .style("font-family","avenir")
        .style("font-size","16");

    for (var i=0; i < stateData.length; i++) {
        svg.append("circle")
        .attr("cx", 50+xscale(stateData[i].changeGDP))
        .attr("cy", 10+yscale(stateData[i].ProbabilityDem))
        .attr("r", rscale(stateData[i].Population))
        .attr("fill",function(d) {
            if (stateData[i].IncParty == "D") {
                return "#139FF1";
            }
            else if (stateData[i].IncParty == "R") {
                return "#E00018";
            }
            else {
                return "#4B0082";
            }
        })
        .attr("stroke","black");
        svg.append("text").text(stateData[i].State)
        .attr("x", 50 + rscale(stateData[i].Population) + xscale(stateData[i].changeGDP))
        .attr("y", 20 + yscale(stateData[i].ProbabilityDem))
        .style("font-family", "avenir");

    }

}
</script>
</div>

<div id="map"></div>

<div>Data from <a href="http://www.ers.usda.gov/data-products/atlas-of-rural-and-small-town-america.aspx">USDA Atlas of Rural and Small-Town America</a>.</div>

<script id="notes">

var svg = d3.select("#map").append("svg").attr("height","1000").attr("width","1000");

var projection = d3.geoAlbersUsa().scale(75);
var pathGenerator = d3.geoPath().projection(projection);

var divergingColors = ["#d8b365", "#f5f5f5", "#5ab4ac"];
var sequentialColors = ['#edf8fb','#b2e2e2','#66c2a4','#2ca25f','#006d2c'];

var populationScale = d3.scaleLinear().domain([-5, 0, 5]).range(divergingColors);
var percentScale = d3.scaleLinear().domain([0, 25, 50, 75, 100]).range(sequentialColors);

var counties, states;
var usdaAtlas;

// function to handle any row-by-row processing on CSV
var parseRow = function(row) {
  return row;
}

d3.queue()
.defer(d3.json,"us.json")
.defer(d3.csv, "statedata.csv", parseRow)
.await(callback);

d3.json("us.json", callback);

function callback (error, rawMap, rawUSDA) {
  console.log("Code in the call-back function is only executed when every data file loads.");

usdaAtlas = d3.map(rawUSDA, function(d){
  return d.FIPS;
});

  counties = topojson.feature(rawMap, rawMap.objects.counties);
  states = topojson.feature(rawMap, rawMap.objects.states);

  showMap(percentScale, "Ed5CollegePlusPct");
}

function showMap(scale, variable) {
  // Create or modify paths for each country

  projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], counties);
  pathGenerator = d3.geoPath().projection(projection);

  var paths = svg.selectAll("path.country").data(states.features);

  paths = paths.enter().append("path").attr("class", "country")
  .on("click", function (d) { console.log(d.id); })
  .merge(paths);

  paths
  .transition().duration(1000)
  .style("fill", function (state) {

  })
  .attr("d", function (state) {
    return pathGenerator(state);
  });

}



console.log("Code after the d3.json() call is executed immediately.");

</script>

<!-- This block will be automatically filled with syntax-highlighted code from the script below -->
<pre><code id="display">
</code></pre>


<script>
document.getElementById("display").innerText = document.getElementById("notes").innerText;
hljs.initHighlightingOnLoad();
</script>


</body>
</html>
